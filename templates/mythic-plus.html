{% extends "layout.html" %}
{% block content %}
<head>
    <style>
    .raid-frame {
        border-radius: 8px;
        margin: 10px;
        padding: 15px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .raid-frame:hover {
        transform: scale(1.1);
    }

    .popup {
        display: none;
        background-color: rgba(74, 79, 78, 0.98);
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 30px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
        width: 60%;
        max-width: 800px;
        z-index: 9999;
        border-radius: 8px;
        max-height: 80vh; /* Limit the height of the popup */
        overflow-y: auto; /* Allow scrolling if content exceeds the height */
    }

    .popup img {
        width: 100px;
        height: 100px;
        border-radius: 50%;
    }

    .popup h2 {
        font-size: 1.5rem;
        color: #363636;
    }

    .popup .close-btn {
        cursor: pointer;
        font-size: 20px;
        position: absolute;
        top: 10px;
        right: 10px;
        font-weight: bold;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title has-text-centered">Mythic+ Dashboard</h1>
        <h3 class="subtitle has-text-centered">Data sourced from Raider.io Dont see your character?? add it using the form below!</h3>

        <!-- Form to Add Character -->
        <div class="add-character-form">
            <h2 class="subtitle">Add Your Character</h2>
            <form id="addCharacterForm">
                <div class="field">
                    <label class="label" for="playerName">Character Name</label>
                    <div class="control">
                        <input class="input" id="playerName" type="text" placeholder="Enter character name" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label" for="playerRealm">Realm</label>
                    <div class="control">
                        <input class="input" id="playerRealm" type="text" placeholder="Enter realm" required>
                    </div>
                </div>
                <div class="field">
                    <label class="label" for="playerClass">Class</label>
                    <div class="control">
                        <div class="select">
                            <select id="playerClass" required>
                                <option value="">Select Class</option>
                                <option value="Monk">Monk</option>
                                <option value="DemonHunter">Demon Hunter</option>
                                <option value="Evoker">Evoker</option>
                                <option value="Shaman">Shaman</option>
                                <option value="Priest">Priest</option>
                                <option value="Paladin">Paladin</option>
                                <option value="Druid">Druid</option>
                                <option value="Hunter">Hunter</option>
                                <option value="Mage">Mage</option>
                                <option value="Warlock">Warlock</option>
                                <option value="Rogue">Rogue</option>
                                <option value="DeathKnight">Death Knight</option>
                                <option value="Warrior">Warrior</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="field">
                    <div class="control">
                        <button class="button is-primary" type="submit">Add Character</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Loop through the players and render each player's frame -->
        <div class="grid is-col-min-10" id="raidFramesContainer">
            {% for player in players %}
            <div class="cell">
            <div class="card raid-frame" id="raid-frame-{{ loop.index }}"
                 style="background-color: {{ player.class.rgb() }};"
                 data-name="{{ player.name }}"
                 data-realm="{{ player.realm }}"
                 data-class="{{ player.class.rgb() }}">
              <div class="card-content">
                <div class="content">
                <h2 class="subtitle has-text-centered has-text-black">{{ player.name }}</h2>
                </div>
              </div>
            </div>
            </div>
            {% endfor %}
        </div>

       
    <div id="popup" class="popup">
        <!-- Popup content will be inserted here via JS -->
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const popup = document.getElementById("popup");
        const addCharacterForm = document.getElementById("addCharacterForm");
        const playerNameInput = document.getElementById("playerName");
        const playerRealmInput = document.getElementById("playerRealm");
        const playerClassSelect = document.getElementById("playerClass");

        // Class colors
        const classColors = {
          DeathKnight: "#C41E3A",
          DemonHunter: "#A330C9",
          Druid: "#FF7C0A",
          Evoker: "#33937F",
          Hunter: "#AAD372",
          Mage: "#3FC7EB",
          Monk: "#00FF98",
          Paladin: "#F48CBA",
          Priest: "#FFFFFF",
          Rogue: "#FFF468",
          Shaman: "#0070DD",
          Warlock: "#8788EE",
          Warrior: "#C69B6D"
        };

        // Function to handle raid frame click
        function handleRaidFrameClick(player) {
          const apiUrl = `https://raider.io/api/v1/characters/profile?region=us&realm=${player.realm}&name=${player.name}&fields=mythic_plus_recent_runs`;

          fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
              displayCharacterInfo(player, data);
            })
            .catch(error => console.error('Error fetching data:', error));
        }

        function displayCharacterInfo(player, character) {
          const recentRunsHTML = generateRecentRunsHTML(character.mythic_plus_recent_runs);

          const popupContent = `
                <span onclick="closePopup()" class="close-btn">&times;</span>
                <h2>${player.name}</h2>
                <img src="${character.thumbnail_url}" alt="Character Thumbnail">
                <p>Race: ${character.race}</p>
                <p>Class: ${character.class}</p>
                <p>Spec: ${character.active_spec_name}</p>
                <p>Role: ${character.active_spec_role}</p>
                <p>Achievement Points: ${character.achievement_points}</p>
                <p>Profile URL: <a href="${character.profile_url}" target="_blank">${character.profile_url}</a></p>

                <h3>Mythic Plus Recent Runs</h3>
                ${recentRunsHTML}
            `;

          popup.innerHTML = popupContent;
          popup.style.display = "block";

          document.addEventListener("click", handleOutsideClick);

          function handleOutsideClick(event) {
            if (!popup.contains(event.target)) {
              closePopup();
              document.removeEventListener("click", handleOutsideClick);
            }
          }
        }

        function generateRecentRunsHTML(recentRuns) {
          return recentRuns.map(run => `
                <p>Dungeon: ${run.dungeon}</p>
                <p>Mythic Level: ${run.mythic_level}</p>
                <p>Completed At: ${run.completed_at}</p>
                <p>Clear Time (ms): ${run.clear_time_ms}</p>
                <p>Par Time (ms): ${run.par_time_ms}</p>
                <p>Num Keystone Upgrades: ${run.num_keystone_upgrades}</p>
                <p>Affixes:</p>
                <ul>
                    ${run.affixes.map(affix => `<li>${affix.name}: ${affix.description}</li>`).join('')}
                </ul>
                <p>URL: <a href="${run.url}" target="_blank">${run.url}</a></p>
                <hr>
            `).join('');
        }

        // Attach click listeners to raid frames
        function attachRaidFrameListeners() {
          const raidFrames = document.querySelectorAll(".raid-frame");
          raidFrames.forEach(frame => {
            frame.addEventListener("click", function() {
              const player = {
                name: frame.dataset.name,
                realm: frame.dataset.realm,
                class: frame.dataset.class
              };
              handleRaidFrameClick(player);
            });
          });
        }


        // Add new player when the form is submitted
        addCharacterForm.addEventListener("submit", function(event) {
          event.preventDefault();

          const playerName = playerNameInput.value.trim();
          const playerRealm = playerRealmInput.value.trim();
          const playerClass = playerClassSelect.value.trim();

          if (!playerName || !playerRealm || !playerClass) {
            alert("Please fill out all fields.");
            return;
          }

          // Create new raid frame (card)
          const newRaidFrame = document.createElement("div");
          newRaidFrame.classList.add("cell");

          const cardDiv = document.createElement("div");
          cardDiv.classList.add("card", "raid-frame");
          cardDiv.style.backgroundColor = classColors[playerClass];
          cardDiv.dataset.name = playerName;
          cardDiv.dataset.realm = playerRealm;
          cardDiv.dataset.class = playerClass;

          const cardContentDiv = document.createElement("div");
          cardContentDiv.classList.add("card-content");

          const contentDiv = document.createElement("div");
          contentDiv.classList.add("content");

          const subtitle = document.createElement("h2");
          subtitle.classList.add("subtitle", "has-text-centered", "has-text-black");
          subtitle.textContent = playerName;

          contentDiv.appendChild(subtitle);
          cardContentDiv.appendChild(contentDiv);
          cardDiv.appendChild(cardContentDiv);
          newRaidFrame.appendChild(cardDiv);

          // Add the new raid frame to the container
          document.getElementById("raidFramesContainer").appendChild(newRaidFrame);

          // Re-attach click listeners to all raid frames, including the new one
          attachRaidFrameListeners();

          // Clear the form inputs
          playerNameInput.value = "";
          playerRealmInput.value = "";
          playerClassSelect.value = "";
        });

        // Close the popup
        window.closePopup = function() {
          popup.style.display = "none";
        };

        // Initial attachment of click listeners when the page loads
        attachRaidFrameListeners();
      });
    </script>
</body>

{% endblock %}
